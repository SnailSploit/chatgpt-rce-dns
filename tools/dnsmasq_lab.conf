# ============================================================
# dnsmasq Lab Configuration for DNS Exfiltration Research
# ============================================================
# 
# This configuration sets up a local authoritative DNS resolver
# for capturing DNS exfiltration queries in a lab environment.
#
# Part of: Dual Critical Failures Research
# Author: Kai Aizen (SnailSploit)
#
# USAGE:
#   1. Install dnsmasq
#   2. Copy this file to /etc/dnsmasq.conf (or /opt/homebrew/etc/dnsmasq.conf on macOS)
#   3. Start dnsmasq: sudo brew services start dnsmasq (macOS) or systemctl start dnsmasq (Linux)
#   4. Set your system DNS to 127.0.0.1
#
# DISCLAIMER: For educational and authorized security research only.
# ============================================================

# ============================================================
# NETWORK BINDING
# ============================================================
# Listen only on loopback - this is a lab setup
listen-address=127.0.0.1,::1
port=53
bind-interfaces

# ============================================================
# UPSTREAM DNS SERVERS
# ============================================================
# Forward non-test queries to public resolvers
server=1.1.1.1
server=2606:4700:4700::1111

# ============================================================
# TEST ZONE CONFIGURATION
# ============================================================
# Make the test zone local and authoritative
# This prevents queries from being forwarded upstream
# and ensures we see the full query name locally

# Primary test zone
local=/exfil.lab/

# Wildcard reply for any name in the zone
# Returns 127.0.0.1 for all A queries (keeps lookups successful)
address=/.exfil.lab/127.0.0.1

# Optional: AAAA records for IPv6
# address=/.exfil.lab/::1

# Additional test zones (optional)
# local=/test.lab/
# address=/.test.lab/127.0.0.1

# ============================================================
# LOGGING CONFIGURATION
# ============================================================
# Per-query logging - CRITICAL for exfiltration capture
log-queries

# Log facility - adjust path as needed
# macOS with Homebrew:
log-facility=/opt/homebrew/var/log/dnsmasq.log

# Linux alternative:
# log-facility=/var/log/dnsmasq.log

# Log DHCP (not needed for this research but useful)
# log-dhcp

# ============================================================
# CACHE SETTINGS
# ============================================================
# Disable caching to ensure all queries are logged
# (Important: repeated exfil queries would otherwise be cached)
cache-size=0

# Alternative: use short TTL
# cache-size=150
# local-ttl=1

# ============================================================
# SECURITY SETTINGS
# ============================================================
# Don't forward queries without a domain
domain-needed

# Don't forward reverse lookups for private ranges
bogus-priv

# ============================================================
# EXPECTED LOG OUTPUT FORMAT
# ============================================================
# 
# Queries will appear in the log like:
#
#   Jun 01 12:00:01 dnsmasq[12345]: query[A] p001_db.MFRGGZDFMZTQ.exfil.lab from 127.0.0.1
#   Jun 01 12:00:01 dnsmasq[12345]: config exfil.lab is local
#   Jun 01 12:00:01 dnsmasq[12345]: reply p001_db.MFRGGZDFMZTQ.exfil.lab is 127.0.0.1
#
# The encoded data is visible in the subdomain labels (p001_db.MFRGGZDFMZTQ)
#
# ============================================================

# ============================================================
# RECONSTRUCTION PROCEDURE
# ============================================================
#
# 1. Parse log file and filter for test zone:
#    grep 'exfil.lab' /opt/homebrew/var/log/dnsmasq.log | grep 'query\[A\]'
#
# 2. Extract subdomain labels:
#    awk -F'query\\[A\\] ' '{print $2}' | awk -F'.exfil.lab' '{print $1}'
#
# 3. Sort by index (p001, p002, etc.)
#
# 4. Concatenate chunks and decode from Base32
#
# See tools/dns_encoder.py for automated encoding/decoding
#
# ============================================================
